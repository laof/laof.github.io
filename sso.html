<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h1> sso validate page</h1>
    <div id="showlog"></div>
    <div id="local_storage"></div>
    <div id="windowname"></div>
    <div id="token"></div>
    <script>
        const search = window.location.search;
        const params = new URLSearchParams(search);
        const my_path = 'my_path';

        const timeout = () => new Promise(res => setTimeout(() => res('done'), 3000));

        function show(message) {
            document.getElementById('showlog').innerText = message;
        }
        function showLocalStorage(message) {
            document.getElementById('local_storage').innerText = message;
        }


        if (params.get('path')) {
            show('1, set path: ' + params.get('path'))
            window.name = JSON.stringify({ my_path: params.get('path'), ts: Date.now() });
            document.getElementById('windowname').innerText = '1 Window.name: ' + window.name;
            timeout().then(() => {
                sessionStorage.setItem(my_path, params.get('path'));
                localStorage.setItem(my_path, params.get('path'));
                const logout = 'https://daolang.netlify.app/ssologout'
                // 登出后回到当前页面
                location.href = `${logout}?redirectURL=${location.origin}/sso?deeplink=openapp4`;
                window.close();
            });
        } else if (params.get('deeplink')) {
            document.getElementById('windowname').innerText = '2 Window.name: ' + window.name;
            // show('2, mcf redirectURL。' + sessionStorage.getItem(my_path));
            show('2, url scheme。' + sessionStorage.getItem(my_path));
            showLocalStorage('showLocalStorage 2, url scheme。' + localStorage.getItem(my_path));
            timeout().then(() => {
                // 3, from mcf redirect
                // location.href = 'https://lttesting.manutouch.com.hk/openapp/uat4/get-token';
                location.href = 'com.manulife.hk.uat.sam4://openapp/get-token';
            });
        } else if (params.get('token')) {
            // step3: 读取
            let saved;
            try { saved = JSON.parse(window.name || '{}'); } catch { saved = {}; }
            const path = saved.my_path;
            document.getElementById('windowname').innerText = '3 Window.name: ' + path;
            show('3, app back: ' + sessionStorage.getItem(my_path));
            showLocalStorage('showLocalStorage 3, app back: ' + localStorage.getItem(my_path));
            timeout().then(() => {
                document.getElementById('token').innerText = '4, Token: ' + params.get('token');
            });
        }


    </script>

</body>

</html>
